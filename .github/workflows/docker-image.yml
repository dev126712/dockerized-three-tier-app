name: Scan Docker Images, Build Docker Images & Publish it to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - 'database/Dockerfile'
      - 'proxy/Dockerfile'

jobs:

  scan:
    runs-on: ubuntu-latest

    steps:
    - name: heckout repo 
      uses: actions/checkout@v4

    - name: Create output directory
      run: mkdir -p "Github Actions/Trivy Automation"

    - name: Instann Trivy
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.57.0
    
    - name: DownloadTrivy vulnerability database
      run: trivy image --download-db-only

    - name: Run Trivy vulnerability scanner
      run: |
        OUTPUT_FILE="GitHub Action/Trivy Automation/scan-results-${DATE}.json"
        mkdir -p "Github Actions/Trivy Automation"
        trivy image --format json --ignore-unfixed --vul-type 0s,library --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" nginx:latest

    - name: Verify scan results exist
      run: ls -l "Github Actions/Trivy Automation"


  build-and-publish:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker images
      run: |
        docker build ./backend/ -t dev126712/dockerized-three-tier-app-backend:latest
        docker build ./frontend/ -t dev126712/dockerized-three-tier-app-frontend:latest
        docker build ./database/ -t dev126712/dockerized-three-tier-app-database:latest
        docker build ./proxy/ -t dev126712/dockerized-three-tier-app-proxy:latest
    - name: push image to docker hub
      run: |
        docker login -u dev126712 -p ${{ secrets.DOCKER_HUB_TOKEN }}
        docker push dev126712/dockerized-three-tier-app-backend:latest
        docker push dev126712/dockerized-three-tier-app-frontend:latest
        docker push dev126712/dockerized-three-tier-app-database:latest
        docker push dev126712/dockerized-three-tier-app-proxy:latest
  
