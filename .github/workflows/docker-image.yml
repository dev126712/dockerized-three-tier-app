name: Scan Docker Images, Build Docker Images & Publish it to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - 'database/Dockerfile'
      - 'proxy/Dockerfile'
      - '.github/workflows/*.yml'

jobs:
  build-and-publish:

    runs-on: ubuntu-latest

    steps:
    - name: checkout repo
      uses: actions/checkout@v4

    - name: Build the Docker images
      run: |
        docker build ./backend/ -t dev126712/dockerized-three-tier-app-backend:latest
        docker build ./frontend/ -t dev126712/dockerized-three-tier-app-frontend:latest
        docker build ./database/ -t dev126712/dockerized-three-tier-app-database:latest
        docker build ./proxy/ -t dev126712/dockerized-three-tier-app-proxy:latest

    - name: set up docker
      uses: docker/setup-buildx-action@v2

    - name: Create output directory
      run: mkdir -p "Github Actions/Trivy Automation"

    - name: Install Trivy
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.57.0

    #- name: Login to GitHub Container Registery
    #  run: echo "{{ secrets.GHCR_PAT }}" | docker login ghcr.io -u {{ github.actor }} --password-stdin
  
    - name: Download Trivy vulnerability database
      run: trivy image --download-db-only

    - name: Run Trivy vulnerability scanner
      env:
        DATE: $(date +%Y-%m-%d)
      run: |

        IMAGES=(
          "dev126712/dockerized-three-tier-app-backend:latest"
          "dev126712/dockerized-three-tier-app-frontend:latest"
          "dev126712/dockerized-three-tier-app-database:latest"
          "dev126712/dockerized-three-tier-app-proxy:latest"
        )

        for IMAGE in "${IMAGES[@]}"; do

          
          echo "Scanning $IMAGE (locally built) and saving to $OUTPUT_FILE"
          
          trivy image \
            --format json \
            --ignore-unfixed \
            --pkg-types os,library \
            --severity CRITICAL,HIGH,MEDIUM \
            "$IMAGE"
        done

    - name: Verify scan results exist
      run: ls -l "Github Actions/Trivy Automation"

    - name: push image to docker hub
      run: |
        docker login -u dev126712 -p ${{ secrets.DOCKER_HUB_TOKEN }}
        docker push dev126712/dockerized-three-tier-app-backend:latest
        docker push dev126712/dockerized-three-tier-app-frontend:latest
        docker push dev126712/dockerized-three-tier-app-database:latest
        docker push dev126712/dockerized-three-tier-app-proxy:latest

