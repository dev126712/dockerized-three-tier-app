name: Scan Docker Images, Build Docker Images & Publish it to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - 'database/Dockerfile'
      - 'proxy/Dockerfile'
      - '.github/workflows/*.yml'
      
jobs:
  build-and-publish:
  
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
    - name: checkout repo
      uses: actions/checkout@v4

    - name: Build the Docker images
      run: |
        docker build ./backend/ -t dev126712/dockerized-three-tier-app-backend:latest
        docker build ./frontend/ -t dev126712/dockerized-three-tier-app-frontend:latest
        docker build ./database/ -t dev126712/dockerized-three-tier-app-database:latest
        docker build ./proxy/ -t dev126712/dockerized-three-tier-app-proxy:latest

    - name: set up docker
      uses: docker/setup-buildx-action@v2

    - name: Create output directory
      run: mkdir -p "Github Actions/Trivy Automation"

    - name: Install Trivy
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.57.0

    #- name: Login to GitHub Container Registery
    #  run: echo "{{ secrets.GHCR_PAT }}" | docker login ghcr.io -u {{ github.actor }} --password-stdin
  
    - name: Download Trivy vulnerability database
      run: trivy image --download-db-only

    - name: create tag with date and time
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "$TIMESTAMP"

    - name: Run Trivy vulnerability scanner && push it to Docker Hub
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |

        docker login -u dev126712 -p ${{ secrets.DOCKER_HUB_TOKEN }}
        IMAGES=(
          "dev126712/dockerized-three-tier-app-backend:latest"
          "dev126712/dockerized-three-tier-app-frontend:latest"
          "dev126712/dockerized-three-tier-app-database:latest"
          "dev126712/dockerized-three-tier-app-proxy:latest"
        )
        OUTPUT_FILE="Github Actions/Trivy Automation/scan-results.json"
        for IMAGE in "${IMAGES[@]}"; do
          echo "Scanning $IMAGE"
          
          OUTPUT_FILE="Github Actions/Trivy Automation/scan-results-$IMAGE.json"
          mkdir -p "Github Actions/Trivy Automation"
          
          trivy image \
            --exit-code 0 \
            --format json \
            --ignore-unfixed \
            --pkg-types os,library \
            --severity CRITICAL,HIGH,MEDIUM \
            > "$OUTPUT_FILE" \
            "$IMAGE" 

            ls -l "Github Actions/Trivy Automation"

            git config --global user.email "solonoobhacker6767@gmail.com"
            git config --global user.name "dev126712"
            git add "Github Actions/Trivy Automation/scan-results-$IMAGE.json"
            git commit -m "Add trivy results (${DATE})"
            git push
            

          TRIVY_STATUS=$?
          
          if [ $TRIVY_STATUS == 0 ]; then
            docker push $IMAGE
            echo "$IMAGE pushed to Docke Hub"
          else 
            echo "Image not push Vulnerability found"
          fi
         done
         
    - name: Verify scan results exist
      run: ls -l "Github Actions/Trivy Automation"
      
